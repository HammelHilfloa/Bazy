<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vereinskalender ‚Äì Monatsansicht (Designvorlage)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --line2:#cbd5e1;

      --brand:#2563eb;   /* arctic blue */
      --navy:#0b2a63;
      --accent:#22d3ee;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(2, 6, 23, .10);
      --radius: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:linear-gradient(180deg,#f7fbff 0%, var(--bg) 60%, var(--bg) 100%);
    }

    .app{
      max-width: 1200px;
      margin: 18px auto;
      padding: 0 14px 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px;
      background: rgba(255,255,255,.86);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .logo{
      width:42px;height:42px;
      border-radius: 14px;
      background: radial-gradient(90% 90% at 25% 20%, #93c5fd 0%, var(--brand) 55%, var(--navy) 100%);
      box-shadow: 0 14px 30px rgba(37,99,235,.22);
      position:relative;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-10px;
      background: linear-gradient(120deg, rgba(255,255,255,.55) 0%, rgba(255,255,255,0) 45%);
      transform: rotate(20deg);
    }
    .brand h1{
      margin:0;
      font-size: 15px;
      line-height: 1.15;
      letter-spacing:.2px;
    }
    .brand .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-size: 13px;
      cursor:pointer;
      transition: .15s transform, .15s box-shadow, .15s border-color;
      box-shadow: 0 2px 10px rgba(2,6,23,.05);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: var(--line2);
      box-shadow: 0 10px 22px rgba(2,6,23,.10);
    }
    .btn.primary{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(180deg, rgba(37,99,235,.10), rgba(37,99,235,.05));
      color: #0b2a63;
    }
    .btn.icon{
      padding:10px 10px;
      width:42px;
      justify-content:center;
    }

    .monthTitle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background:#fff;
      box-shadow: 0 2px 10px rgba(2,6,23,.05);
      font-size: 13px;
    }
    .monthTitle b{
      font-size: 13px;
      letter-spacing:.2px;
    }
    .monthTitle small{
      color:var(--muted);
      font-weight: 600;
    }

    .main{
      margin-top: 14px;
      background: rgba(255,255,255,.86);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .mainHead{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,211,238,.10), rgba(255,255,255,0));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .mainHead .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .legend{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      font-size: 12px;
      color: var(--muted);
    }
    .tag{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background:#fff;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--brand);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    }
    .dot.a{ background: var(--accent); box-shadow: 0 0 0 3px rgba(34,211,238,.15); }
    .dot.g{ background: var(--ok); box-shadow: 0 0 0 3px rgba(22,163,74,.15); }
    .dot.y{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.15); }
    .dot.r{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.15); }

    /* Calendar grid wrapper (horizontal scroll on very small screens) */
    .calWrap{
      padding: 12px;
      overflow:auto;
    }

    /* Weekday header */
    .weekdays{
      min-width: 820px; /* readable columns; activates horizontal scroll below */
      display:grid;
      grid-template-columns: repeat(7, minmax(110px, 1fr));
      gap:10px;
      margin-bottom:10px;
    }
    .weekday{
      font-size: 12px;
      font-weight: 800;
      color: var(--navy);
      text-transform: uppercase;
      letter-spacing: .6px;
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(37,99,235,.08), rgba(255,255,255,0));
    }

    /* Weeks: each week is a "row" with 7 day cells + an overlay for multi-day bars */
    .weeks{
      min-width: 820px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .week{
      position: relative;
      display:grid;
      grid-template-columns: repeat(7, minmax(110px, 1fr));
      gap:10px;
    }

    .day{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      min-height: 118px;
      padding: 10px 10px 8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      transition: border-color .15s, box-shadow .15s, transform .15s;
      overflow:hidden;
    }
    .day:hover{
      border-color: var(--line2);
      box-shadow: 0 10px 24px rgba(2,6,23,.08);
      transform: translateY(-1px);
    }

    .day.out{
      background: linear-gradient(180deg, rgba(2,6,23,.02), rgba(255,255,255,0));
      color: var(--muted);
    }

    .dayHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .dayNum{
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      font-size: 14px;
      color: var(--text);
      line-height:1;
    }
    .day.out .dayNum{ color: var(--muted); }

    .todayRing{
      position:absolute;
      inset:10px 10px auto auto;
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(34,211,238,.18);
      display:none;
    }
    .day.today .todayRing{ display:block; }

    .mini{
      font-size: 11px;
      color: var(--muted);
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(2,6,23,.02);
      white-space:nowrap;
    }

    /* Selection (for click-range creation) */
    .day.selecting{
      outline: 3px solid rgba(37,99,235,.25);
      outline-offset: 2px;
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(180deg, rgba(37,99,235,.06), rgba(255,255,255,0));
    }
    .day.selected{
      outline: 3px solid rgba(34,211,238,.28);
      outline-offset: 2px;
      border-color: rgba(34,211,238,.40);
      background: linear-gradient(180deg, rgba(34,211,238,.08), rgba(255,255,255,0));
    }

    /* Multi-day event bars overlay: split per week, spanning columns */
    .barsLayer{
      position:absolute;
      left:0; right:0;
      top: 46px;   /* start below day headers */
      bottom: 8px;
      display:grid;
      grid-template-columns: repeat(7, minmax(110px, 1fr));
      gap:10px;
      pointer-events:none; /* bars are clickable but container won't block */
      z-index: 5;
    }
    .bar{
      pointer-events:auto;
      height: 26px;
      border-radius: 10px;
      border:1px solid rgba(2,6,23,.10);
      display:flex;
      align-items:center;
      gap:8px;
      padding: 0 10px;
      font-size: 12px;
      font-weight: 800;
      overflow:hidden;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(2,6,23,.10);
      white-space:nowrap;
    }
    .bar small{
      font-weight: 800;
      opacity:.75;
    }
    .bar.training{
      color:#0b2a63;
      background: linear-gradient(180deg, rgba(37,99,235,.18), rgba(37,99,235,.08));
      box-shadow: 0 10px 22px rgba(37,99,235,.14);
    }
    .bar.verein{
      color:#083344;
      background: linear-gradient(180deg, rgba(34,211,238,.22), rgba(34,211,238,.10));
      box-shadow: 0 10px 22px rgba(34,211,238,.14);
    }
    .bar.wettkampf{
      color:#052e16;
      background: linear-gradient(180deg, rgba(22,163,74,.18), rgba(22,163,74,.08));
      box-shadow: 0 10px 22px rgba(22,163,74,.12);
    }
    .bar.lehrgang{
      color:#451a03;
      background: linear-gradient(180deg, rgba(245,158,11,.22), rgba(245,158,11,.10));
      box-shadow: 0 10px 22px rgba(245,158,11,.12);
    }
    .bar.wichtig{
      color:#450a0a;
      background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.08));
      box-shadow: 0 10px 22px rgba(239,68,68,.12);
    }

    /* Each bar row offset (lane) */
    .lane-0{ transform: translateY(0px); }
    .lane-1{ transform: translateY(30px); }
    .lane-2{ transform: translateY(60px); }
    .lane-3{ transform: translateY(90px); }
    .lane-4{ transform: translateY(120px); }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 200;
    }
    .modalBackdrop.show{ display:flex; }

    .modal{
      width: min(560px, 100%);
      background:#fff;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.2);
      box-shadow: 0 30px 80px rgba(2,6,23,.45);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(37,99,235,.10), rgba(255,255,255,0));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .modalHead h3{
      margin:0;
      font-size: 14px;
    }
    .modalHead p{
      margin:4px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }
    .modalBody{
      padding: 14px 16px 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 560px){
      .modalBody{ grid-template-columns: 1fr; }
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    input, select, textarea{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height: 84px; resize: vertical; grid-column: 1 / -1; }
    .modalFoot{
      padding: 12px 16px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      background: rgba(2,6,23,.02);
    }

    .toast{
      position: fixed;
      left: 16px;
      bottom: 16px;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(15,23,42,.92);
      color: #fff;
      font-size: 13px;
      display:none;
      z-index: 250;
      box-shadow: 0 18px 40px rgba(2,6,23,.35);
      max-width: min(520px, calc(100% - 32px));
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Vereinskalender ‚Äì Monatsansicht</h1>
          <div class="sub">Designvorlage ¬∑ Monatswechsel per Pfeile ¬∑ Mehrtages-Termine als Balken</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn icon" id="prevBtn" title="Vorheriger Monat">‚Üê</button>
        <div class="monthTitle" aria-live="polite">
          <b id="monthLabel">‚Äî</b>
          <small id="monthMeta">‚Äî</small>
        </div>
        <button class="btn icon" id="nextBtn" title="N√§chster Monat">‚Üí</button>

        <button class="btn primary" id="newEventBtn" title="Neuen Termin anlegen">
          ‚ûï Neuer Termin
        </button>
        <button class="btn" id="todayBtn" title="Springe zu heute">üìç Heute</button>
      </div>
    </header>

    <section class="main">
      <div class="mainHead">
        <div>
          <div class="hint">
            <b>Range-Erstellung:</b> Klicke einen Tag (Start) und danach einen zweiten Tag (Ende).
            Danach √∂ffnet sich der Dialog automatisch. Termine k√∂nnen √ºber mehrere Tage laufen.
          </div>
        </div>
        <div class="legend" aria-label="Legende">
          <span class="tag"><span class="dot"></span> Training</span>
          <span class="tag"><span class="dot a"></span> Verein</span>
          <span class="tag"><span class="dot g"></span> Wettkampf</span>
          <span class="tag"><span class="dot y"></span> Lehrgang</span>
          <span class="tag"><span class="dot r"></span> Wichtig</span>
        </div>
      </div>

      <div class="calWrap">
        <div class="weekdays" id="weekdays"></div>
        <div class="weeks" id="weeks"></div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="modalTitle">Termin erstellen</h3>
          <p id="modalSubtitle">Mehrtagestermin m√∂glich.</p>
        </div>
        <button class="btn icon" id="closeModalBtn" title="Schlie√üen">‚úï</button>
      </div>

      <div class="modalBody">
        <label>
          Titel
          <input id="evTitle" placeholder="z. B. Nikolausturnier, Vorstandssitzung, Trainingslager‚Ä¶" />
        </label>

        <label>
          Kategorie
          <select id="evCat">
            <option value="training">Training</option>
            <option value="verein">Verein</option>
            <option value="wettkampf">Wettkampf</option>
            <option value="lehrgang">Lehrgang</option>
            <option value="wichtig">Wichtig</option>
          </select>
        </label>

        <label>
          Startdatum
          <input id="evStart" type="date" />
        </label>

        <label>
          Enddatum
          <input id="evEnd" type="date" />
        </label>

        <label style="grid-column:1/-1;">
          Notiz (optional)
          <textarea id="evNote" placeholder="Optional: Ort, Uhrzeit, Hinweise‚Ä¶"></textarea>
        </label>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="deleteBtn" style="display:none;">üóëÔ∏è L√∂schen</button>
        <div style="display:flex; gap:8px; margin-left:auto;">
          <button class="btn" id="cancelBtn">Abbrechen</button>
          <button class="btn primary" id="saveBtn">Speichern</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Utilities =====
    const pad2 = (n) => String(n).padStart(2,'0');
    const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const fromISO = (s) => {
      const [y,m,d] = s.split('-').map(Number);
      return new Date(y, m-1, d, 12, 0, 0, 0); // midday to avoid DST edge issues
    };
    const startOfMonth = (y,m) => new Date(y,m,1,12,0,0,0);
    const endOfMonth = (y,m) => new Date(y,m+1,0,12,0,0,0);

    // Monday as first day (Germany)
    const dayIndexMon0 = (date) => (date.getDay() + 6) % 7; // Mon=0..Sun=6

    function addDays(date, n){
      const d = new Date(date);
      d.setDate(d.getDate() + n);
      return d;
    }

    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear()
        && a.getMonth()===b.getMonth()
        && a.getDate()===b.getDate();
    }

    function clampDate(d, min, max){
      return new Date(Math.min(Math.max(d.getTime(), min.getTime()), max.getTime()));
    }

    function intersects(evStart, evEnd, rangeStart, rangeEnd){
      return evStart <= rangeEnd && evEnd >= rangeStart;
    }

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.remove('show'), 2600);
    }

    // ===== Demo state (later: MySQL) =====
    const state = {
      view: new Date(2026, 0, 1, 12,0,0,0),
      events: [
        { id: crypto.randomUUID(), title:"Technikblock U11/U13", cat:"training", start:"2026-01-12", end:"2026-01-18", note:"" },
        { id: crypto.randomUUID(), title:"Vorstand", cat:"verein", start:"2026-01-21", end:"2026-01-21", note:"19:00" },
        { id: crypto.randomUUID(), title:"Bezirksturnier", cat:"wettkampf", start:"2026-01-31", end:"2026-02-01", note:"" },
      ],
      // range selection
      rangeStart: null,
      rangeEnd: null,
      editingId: null,
    };

    // ===== Elements =====
    const weekdaysEl = document.getElementById('weekdays');
    const weeksEl = document.getElementById('weeks');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const todayBtn = document.getElementById('todayBtn');
    const newEventBtn = document.getElementById('newEventBtn');

    const monthLabel = document.getElementById('monthLabel');
    const monthMeta = document.getElementById('monthMeta');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    const evTitle = document.getElementById('evTitle');
    const evCat = document.getElementById('evCat');
    const evStart = document.getElementById('evStart');
    const evEnd = document.getElementById('evEnd');
    const evNote = document.getElementById('evNote');
    const modalSubtitle = document.getElementById('modalSubtitle');

    // ===== Render helpers =====
    function renderWeekdays(){
      const names = ["Mo","Di","Mi","Do","Fr","Sa","So"];
      weekdaysEl.innerHTML = names.map(n=>`<div class="weekday">${n}</div>`).join('');
    }

    function setMonthLabel(date){
      const fmt = new Intl.DateTimeFormat('de-DE', { month:'long', year:'numeric' });
      const s = fmt.format(date);
      monthLabel.textContent = s.charAt(0).toUpperCase() + s.slice(1);
      monthMeta.textContent = "Monatsansicht";
    }

    function buildGridDates(viewDate){
      const y = viewDate.getFullYear();
      const m = viewDate.getMonth();

      const first = startOfMonth(y,m);
      const last = endOfMonth(y,m);

      // start grid on Monday
      const offset = dayIndexMon0(first);
      const gridStart = addDays(first, -offset);

      // 6 weeks => 42 days
      const days = [];
      for (let i=0; i<42; i++){
        const d = addDays(gridStart, i);
        days.push({
          date: d,
          iso: toISO(d),
          inMonth: d.getMonth() === m,
        });
      }

      return { days, gridStart, first, last };
    }

    // Split an event into week-segments (Mon..Sun) inside the current 6-week grid
    function eventToSegments(ev, gridStart){
      const evS = fromISO(ev.start);
      const evE = fromISO(ev.end);

      const segments = [];

      for (let w=0; w<6; w++){
        const weekStart = addDays(gridStart, w*7);
        const weekEnd = addDays(weekStart, 6);

        if (!intersects(evS, evE, weekStart, weekEnd)) continue;

        const segStart = clampDate(evS, weekStart, weekEnd);
        const segEnd   = clampDate(evE, weekStart, weekEnd);

        const startIdx = dayIndexMon0(segStart); // 0..6
        const endIdx   = dayIndexMon0(segEnd);   // 0..6

        segments.push({
          week: w,
          startCol: startIdx + 1, // CSS grid columns are 1-based
          endCol: endIdx + 2,     // end is exclusive in CSS grid
          ev
        });
      }
      return segments;
    }

    // Assign vertical lanes per week so bars don't overlap
    function assignLanes(segmentsForWeek){
      // sort by startCol then by longer first
      const segs = [...segmentsForWeek].sort((a,b)=>{
        if (a.startCol !== b.startCol) return a.startCol - b.startCol;
        return (b.endCol - b.startCol) - (a.endCol - a.startCol);
      });

      const laneEnds = []; // laneEnds[i] = endCol last used
      for (const s of segs){
        let lane = 0;
        while (lane < laneEnds.length && laneEnds[lane] > s.startCol) lane++;
        if (lane === laneEnds.length) laneEnds.push(0);
        s.lane = lane;
        laneEnds[lane] = s.endCol;
      }
      return segs;
    }

    function clearSelection(){
      state.rangeStart = null;
      state.rangeEnd = null;
    }

    function render(){
      renderWeekdays();
      setMonthLabel(state.view);

      const today = new Date();
      const { days, gridStart, first, last } = buildGridDates(state.view);

      // group into weeks
      const weeks = [];
      for (let w=0; w<6; w++){
        weeks.push(days.slice(w*7, w*7 + 7));
      }

      // filter events that intersect visible grid range
      const gridEnd = addDays(gridStart, 41);
      const visibleEvents = state.events.filter(ev=>{
        const s = fromISO(ev.start);
        const e = fromISO(ev.end);
        return intersects(s,e,gridStart,gridEnd);
      });

      // create all segments
      const allSegments = [];
      for (const ev of visibleEvents){
        allSegments.push(...eventToSegments(ev, gridStart));
      }

      // render weeks
      weeksEl.innerHTML = "";

      weeks.forEach((weekDays, wIdx)=>{
        const weekEl = document.createElement('div');
        weekEl.className = 'week';

        // day cells
        weekDays.forEach(d=>{
          const dayEl = document.createElement('div');
          dayEl.className = 'day' + (d.inMonth ? '' : ' out');

          if (isSameDay(d.date, today)) dayEl.classList.add('today');

          // selection styling
          if (state.rangeStart && state.rangeEnd){
            const rs = fromISO(state.rangeStart);
            const re = fromISO(state.rangeEnd);
            if (d.date >= rs && d.date <= re) dayEl.classList.add('selected');
          } else if (state.rangeStart && d.iso === state.rangeStart){
            dayEl.classList.add('selecting');
          }

          dayEl.dataset.iso = d.iso;

          const header = document.createElement('div');
          header.className = 'dayHeader';

          const dayNum = document.createElement('div');
          dayNum.className = 'dayNum';
          dayNum.textContent = d.date.getDate();

          const badge = document.createElement('div');
          badge.className = 'mini';
          badge.textContent = d.inMonth ? '' : new Intl.DateTimeFormat('de-DE',{month:'short'}).format(d.date);

          const ring = document.createElement('div');
          ring.className = 'todayRing';

          header.appendChild(dayNum);
          header.appendChild(badge);

          dayEl.appendChild(header);
          dayEl.appendChild(ring);

          // click to range-select
          dayEl.addEventListener('click', ()=>{
            handleDayClick(d.iso);
          });

          weekEl.appendChild(dayEl);
        });

        // bars overlay for this week
        const layer = document.createElement('div');
        layer.className = 'barsLayer';

        const segs = allSegments.filter(s=>s.week === wIdx);
        const segsWithLanes = assignLanes(segs);

        segsWithLanes.forEach(seg=>{
          const bar = document.createElement('div');
          bar.className = `bar ${seg.ev.cat} lane-${Math.min(seg.lane,4)}`;
          bar.style.gridColumn = `${seg.startCol} / ${seg.endCol}`;
          bar.title = `${seg.ev.title} (${seg.ev.start} ‚Üí ${seg.ev.end})\nKlicken zum Bearbeiten/L√∂schen (Demo)`;

          // content
          const span = document.createElement('span');
          span.textContent = seg.ev.title;

          // show date range only on first week-segment of this event (nice for readability)
          const evStart = fromISO(seg.ev.start);
          const evEnd = fromISO(seg.ev.end);
          const isFirstVisibleSegment =
            (seg.startCol === (dayIndexMon0(clampDate(evStart, addDays(gridStart, wIdx*7), addDays(gridStart, wIdx*7+6))) + 1));

          const small = document.createElement('small');
          small.textContent = isFirstVisibleSegment ? ` ${prettyRange(seg.ev.start, seg.ev.end)}` : '';

          bar.appendChild(span);
          bar.appendChild(small);

          bar.addEventListener('click', (e)=>{
            e.stopPropagation();
            openModalForEdit(seg.ev.id);
          });

          layer.appendChild(bar);
        });

        weekEl.appendChild(layer);
        weeksEl.appendChild(weekEl);
      });
    }

    function prettyRange(startIso, endIso){
      if (startIso === endIso){
        const d = fromISO(startIso);
        return `(${d.getDate()}.${d.getMonth()+1}.)`;
      }
      const s = fromISO(startIso);
      const e = fromISO(endIso);
      const sameMonth = s.getMonth() === e.getMonth() && s.getFullYear() === e.getFullYear();
      return sameMonth
        ? `(${s.getDate()}.${s.getMonth()+1}.‚Äì${e.getDate()}.${e.getMonth()+1}.)`
        : `(${s.getDate()}.${s.getMonth()+1}.‚Äì${e.getDate()}.${e.getMonth()+1}.)`;
    }

    // ===== Interaction: month navigation =====
    prevBtn.addEventListener('click', ()=>{
      state.view = new Date(state.view.getFullYear(), state.view.getMonth()-1, 1, 12,0,0,0);
      clearSelection();
      render();
    });
    nextBtn.addEventListener('click', ()=>{
      state.view = new Date(state.view.getFullYear(), state.view.getMonth()+1, 1, 12,0,0,0);
      clearSelection();
      render();
    });
    todayBtn.addEventListener('click', ()=>{
      const t = new Date();
      state.view = new Date(t.getFullYear(), t.getMonth(), 1, 12,0,0,0);
      clearSelection();
      render();
      toast("Zu ‚ÄûHeute‚Äú gesprungen.");
    });

    // ===== Range selection creation =====
    function handleDayClick(iso){
      if (!state.rangeStart){
        state.rangeStart = iso;
        state.rangeEnd = null;
        render();
        return;
      }
      // second click sets end
      const a = fromISO(state.rangeStart);
      const b = fromISO(iso);
      const [start, end] = a <= b ? [toISO(a), toISO(b)] : [toISO(b), toISO(a)];
      state.rangeStart = start;
      state.rangeEnd = end;

      render();
      openModalForNew(start, end);
    }

    // ===== Modal =====
    function openModalForNew(startIso=null, endIso=null){
      state.editingId = null;
      deleteBtn.style.display = "none";

      evTitle.value = "";
      evCat.value = "training";
      evNote.value = "";

      const y = state.view.getFullYear();
      const m = state.view.getMonth();
      const first = startOfMonth(y,m);
      const last = endOfMonth(y,m);

      // default dates: either selected range, or today (clamped)
      const d0 = startIso ? fromISO(startIso) : new Date();
      const d1 = endIso ? fromISO(endIso) : d0;

      const s = clampDate(d0, first, last);
      const e = clampDate(d1, first, last);

      evStart.value = toISO(s);
      evEnd.value = toISO(e);

      modalSubtitle.textContent = "Start/Ende anpassen ‚Äì Termin kann √ºber mehrere Tage gehen.";
      showModal();
      evTitle.focus();
    }

    function openModalForEdit(id){
      const ev = state.events.find(e=>e.id===id);
      if (!ev) return;

      state.editingId = id;
      deleteBtn.style.display = "inline-flex";

      evTitle.value = ev.title;
      evCat.value = ev.cat;
      evStart.value = ev.start;
      evEnd.value = ev.end;
      evNote.value = ev.note || "";

      modalSubtitle.textContent = "Bearbeiten oder l√∂schen (Demo ‚Äì sp√§ter MySQL).";
      showModal();
      evTitle.focus();
    }

    function showModal(){
      modalBackdrop.classList.add('show');
    }
    function hideModal(){
      modalBackdrop.classList.remove('show');
    }

    closeModalBtn.addEventListener('click', hideModal);
    cancelBtn.addEventListener('click', hideModal);
    modalBackdrop.addEventListener('click', (e)=>{
      if (e.target === modalBackdrop) hideModal();
    });
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && modalBackdrop.classList.contains('show')) hideModal();
    });

    newEventBtn.addEventListener('click', ()=>{
      clearSelection();
      render();
      openModalForNew();
    });

    saveBtn.addEventListener('click', ()=>{
      const title = evTitle.value.trim();
      const cat = evCat.value;
      const start = evStart.value;
      const end = evEnd.value;
      const note = evNote.value.trim();

      if (!title){
        toast("Bitte einen Titel eingeben.");
        evTitle.focus();
        return;
      }
      if (!start || !end){
        toast("Bitte Start- und Enddatum setzen.");
        return;
      }
      const s = fromISO(start);
      const e = fromISO(end);
      if (s > e){
        toast("Enddatum muss nach dem Startdatum liegen.");
        return;
      }

      if (state.editingId){
        const ev = state.events.find(x=>x.id===state.editingId);
        if (ev){
          ev.title = title; ev.cat = cat; ev.start = start; ev.end = end; ev.note = note;
        }
        toast("Termin aktualisiert (Demo).");
      } else {
        state.events.push({ id: crypto.randomUUID(), title, cat, start, end, note });
        toast("Termin erstellt (Demo).");
      }

      clearSelection();
      hideModal();
      render();
    });

    deleteBtn.addEventListener('click', ()=>{
      if (!state.editingId) return;
      state.events = state.events.filter(e=>e.id !== state.editingId);
      state.editingId = null;
      clearSelection();
      hideModal();
      render();
      toast("Termin gel√∂scht (Demo).");
    });

    // ===== Init =====
    render();
  </script>
</body>
</html>
