<script>
      const LS_TOKEN = "vh_token";
      let token = localStorage.getItem(LS_TOKEN) || "";
      let sessionUser = null;

      let allTrainings = [];
      let allMine = [];
      let allUnavailable = [];

      const $ = (id) => document.getElementById(id);

      function showLoginMsg(msg) {
        const el = $("loginMsg");
        if (!el) return;
        el.textContent = msg || "";
        el.style.display = msg ? "block" : "none";
      }

      function api(name, ...args) {
        // ALWAYS resolve -> no silent failures
        return new Promise((resolve) => {
          google.script.run
            .withSuccessHandler((res) => resolve(res))
            .withFailureHandler((err) => {
              const msg =
                (err && err.message) ? err.message :
                (typeof err === "string" ? err : JSON.stringify(err));
              resolve({ ok: false, error: msg });
            })[name](...args);
        });
      }

      function setActiveTab(tab) {
        document.querySelectorAll(".tabs .tab").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
        document.querySelectorAll(".panel").forEach(p => p.style.display = "none");
        const panel = $("panel-" + tab);
        if (panel) panel.style.display = "block";
      }

      function setActiveSubtab(subtab) {
        document.querySelectorAll(".subTabs .tab").forEach(b => b.classList.toggle("active", b.dataset.subtab === subtab));
        $("panel-adminTrainings").style.display = (subtab === "adminTrainings") ? "block" : "none";
        $("panel-adminUsers").style.display = (subtab === "adminUsers") ? "block" : "none";
      }

      async function loadTrainerSelect() {
        const res = await api("apiListActiveTrainers");
        const sel = $("trainerSelect");
        sel.innerHTML = "";
        if (!res.ok) {
          sel.innerHTML = `<option value="">Fehler</option>`;
          showLoginMsg(res.error || "Trainerliste konnte nicht geladen werden.");
          return;
        }
        res.items.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.trainer_id;
          opt.textContent = t.name + (t.email ? ` (${t.email})` : "");
          sel.appendChild(opt);
        });
      }

      const monthKeyFromDate = (str) => {
        const raw = String(str || "");
        return raw.length >= 10 ? raw.slice(3, 10) : ""; // "MM.YYYY" from "DD.MM.YYYY"
      };

      function initFilters() {
        const months = new Map();
        const groups = new Set();

        allTrainings.forEach(t => {
          const key = monthKeyFromDate(t.datum);
          if (key) months.set(key, key);
          if (t.gruppe) groups.add(t.gruppe);
        });

        const mSel = $("filterMonth");
        const gSel = $("filterGroup");

        const curMonth = mSel.value;
        const curGroup = gSel.value;

        mSel.innerHTML = `<option value="ALL">Alle</option>` +
          Array.from(months.values()).sort((a,b)=>a.localeCompare(b, "de")).map(m => `<option value="${m}">${m}</option>`).join("");

        gSel.innerHTML = `<option value="ALL">Alle</option>` +
          Array.from(groups.values()).sort((a,b)=>a.localeCompare(b, "de")).map(g => `<option value="${g}">${g}</option>`).join("");

        if (curMonth) mSel.value = curMonth;
        if (curGroup) gSel.value = curGroup;
      }

      function getFilteredTrainings() {
        const m = $("filterMonth").value;
        const g = $("filterGroup").value;
        const critical = $("filterCritical").value === "1";
        return allTrainings.filter(t => {
          if (m !== "ALL") {
            const key = (t.datum || "").slice(3,10);
            if (key !== m) return false;
          }
          if (g !== "ALL" && String(t.gruppe) !== String(g)) return false;
          if (critical && !(Number(t.eingeteilt || 0) === 0)) return false;
          return true;
        });
      }

      function initMineFilters() {
        const sel = $("filterMineMonth");
        if (!sel) return;

        const months = new Map();
        allMine.forEach(e => {
          const key = monthKeyFromDate(e.datum);
          if (key) months.set(key, key);
        });
        allUnavailable.forEach(u => {
          const key = monthKeyFromDate(u.label || u.datum);
          if (key) months.set(key, key);
        });

        const cur = sel.value || "ALL";
        sel.innerHTML = `<option value="ALL">Ganzes Jahr</option>` +
          Array.from(months.values()).sort((a,b)=>a.localeCompare(b, "de")).map(m => `<option value="${m}">${m}</option>`).join("");
        if (cur) sel.value = cur;
      }

      function getFilteredMineEntries() {
        const sel = $("filterMineMonth");
        const m = sel ? sel.value : "ALL";
        if (m === "ALL") return allMine;
        return allMine.filter(e => monthKeyFromDate(e.datum) === m);
      }

      function getFilteredUnavailable() {
        const sel = $("filterMineMonth");
        const m = sel ? sel.value : "ALL";
        if (m === "ALL") return allUnavailable;
        return allUnavailable.filter(u => monthKeyFromDate(u.label || u.datum) === m);
      }

      function renderTrainings(list, container, withAdminButtons=false) {
        container.innerHTML = "";
        if (!list || !list.length) {
          container.innerHTML = `<div class="empty">Keine Einträge.</div>`;
          return;
        }

        list.forEach(t => {
          const badges = [];

          const assigned = (typeof t.eingeteilt === "number") ? t.eingeteilt
                          : (typeof t.benoetigt_trainer === "number" && typeof t.offen === "number")
                            ? (t.benoetigt_trainer - t.offen)
                            : 0;

          badges.push(`<span class="badge group">${t.gruppe || ""}</span>`);
          badges.push(`<span class="badge">${t.status || ""}</span>`);

          if (assigned >= 1) badges.push(`<span class="badge ok">Minimum ✓</span>`);
          else badges.push(`<span class="badge danger">Kein Trainer!</span>`);

          if (t.offen === 0) badges.push(`<span class="badge ok">Optimal</span>`);
          else badges.push(`<span class="badge warn">Noch ${t.offen}</span>`);

          if (t.is_unavailable) badges.push(`<span class="badge info">Nicht verfügbar</span>`);

          // ... innerhalb list.forEach(t => { ... })

const timeLine = (t.start && t.ende) ? `${t.start}–${t.ende}` : "";
const subLine = [timeLine, t.ort].filter(Boolean).join(" · ");

let actions = "";

// ✅ Admin-Ansicht: NUR Details + Statusbuttons
if (withAdminButtons) {
  actions = `
    <button class="btn small ghost" data-details="${t.training_id}">Details</button>
    <button class="btn small" data-admin-status="stattgefunden" data-training="${t.training_id}">stattgefunden</button>
    <button class="btn small danger" data-admin-status="ausgefallen" data-training="${t.training_id}">ausgefallen</button>
  `;
} else {
  // ✅ normale Ansicht: Details + Nicht verfügbar + Übernehme
  const disabledEnroll = (t.status !== "geplant") || (Number(t.offen) <= 0) || !!t.is_unavailable;

  const unavailBtn = t.is_unavailable
    ? `<button class="btn small" data-unavail-off="${t.training_id}">Wieder verfügbar</button>`
    : `<button class="btn small ghost" data-unavail-on="${t.training_id}">Nicht verfügbar</button>`;

  actions = `
    <button class="btn small ghost" data-details="${t.training_id}">Details</button>
    ${unavailBtn}
    <button class="btn small" ${disabledEnroll ? "disabled": ""} data-enroll="${t.training_id}">Übernehme</button>
  `;
}

          const html = `
            <div class="item">
              <div class="itemMain">
                <div class="itemTitle">
                  <span class="date">${t.datum || ""}</span>
                  ${t.gruppe ? ` · <b>${t.gruppe}</b>` : ""}
                </div>
                <div class="itemSub">${subLine || ""}</div>
                <div class="badges">${badges.join("")}</div>
              </div>
              <div class="itemActions">${actions}</div>
            </div>
          `;
          container.insertAdjacentHTML("beforeend", html);
        });

        // details
        container.querySelectorAll("[data-details]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-details");
            await openTrainingDetails(id);
          });
        });

        // unavailable toggle + enroll (nur wenn withAdminButtons=false)
        if (!withAdminButtons) {
          container.querySelectorAll("[data-unavail-on]").forEach(btn => {
            btn.addEventListener("click", async () => {
              const tid = btn.getAttribute("data-unavail-on");
              const res = await api("apiSetUnavailable", token, tid, "");
              if (!res.ok) return alert(res.error || "Fehler");
              await refreshAll();
            });
          });
          container.querySelectorAll("[data-unavail-off]").forEach(btn => {
            btn.addEventListener("click", async () => {
              const tid = btn.getAttribute("data-unavail-off");
              const res = await api("apiUnsetUnavailable", token, tid);
              if (!res.ok) return alert(res.error || "Fehler");
              await refreshAll();
            });
          });

          // enroll
          container.querySelectorAll("[data-enroll]").forEach(btn => {
            btn.addEventListener("click", async () => {
              btn.disabled = true;
              try {
                const id = btn.getAttribute("data-enroll");
                const res = await api("apiEnroll", token, id);
                if (!res.ok) alert(res.error || "Fehler");
                await refreshAll();
                setActiveTab("mine");
              } finally {
                btn.disabled = false;
              }
            });
          });
        }

        // admin status (nur wenn withAdminButtons=true)
        if (withAdminButtons) {
          container.querySelectorAll("[data-admin-status]").forEach(btn => {
            btn.addEventListener("click", async () => {
              const trainingId = btn.getAttribute("data-training");
              const status = btn.getAttribute("data-admin-status");
              let reason = "";
              if (status === "ausgefallen") {
                reason = prompt("Ausfallgrund (z.B. Ferien/Krank/…):", "Ferien") || "Admin";
              }
              const res = await api("apiAdminSetTrainingStatus", token, trainingId, status, reason);
              if (!res.ok) alert(res.error || "Fehler");
              await refreshAll();
            });
          });
        }
      }

      // ===== Admin filters =====
      function initAdminFilters() {
        const months = new Map();
        const groups = new Set();
        allTrainings.forEach(t => {
          const key = (t.datum || "").slice(3,10);
          if (key) months.set(key, key);
          if (t.gruppe) groups.add(t.gruppe);
        });

        const mSel = $("filterAdminMonth");
        const gSel = $("filterAdminGroup");

        const curMonth = mSel && mSel.value;
        const curGroup = gSel && gSel.value;

        if (mSel) mSel.innerHTML = `<option value="ALL">Alle</option>` +
          Array.from(months.values()).sort((a,b)=>a.localeCompare(b, "de")).map(m => `<option value="${m}">${m}</option>`).join("");

        if (gSel) gSel.innerHTML = `<option value="ALL">Alle</option>` +
          Array.from(groups.values()).sort((a,b)=>a.localeCompare(b, "de")).map(g => `<option value="${g}">${g}</option>`).join("");

        if (mSel && curMonth) mSel.value = curMonth;
        if (gSel && curGroup) gSel.value = curGroup;
      }

      function getFilteredAdminTrainings() {
        const m = $("filterAdminMonth").value;
        const g = $("filterAdminGroup").value;
        const status = $("filterAdminStatus").value;
        return allTrainings.filter(t => {
          if (m !== "ALL") {
            const key = (t.datum || "").slice(3,10);
            if (key !== m) return false;
          }
          if (g !== "ALL" && String(t.gruppe) !== String(g)) return false;
          if (status && status !== "ALL" && String(t.status) !== String(status)) return false;
          return true;
        });
      }

      function renderMine(list) {
        const container = $("mineList");
        container.innerHTML = "";
        if (!list || !list.length) {
          container.innerHTML = `<div class="empty">Noch keine Einteilungen.</div>`;
          return;
        }

        list.forEach(e => {
          const badges = [];
          if (e.gruppe) badges.push(`<span class="badge group">${e.gruppe}</span>`);
          if (e.training_status) badges.push(`<span class="badge">${e.training_status}</span>`);
          if (e.attendance) badges.push(`<span class="badge">${e.attendance}</span>`);
          if (e.checkin_am) badges.push(`<span class="badge ok">Check-in: ${e.checkin_am}</span>`);

          const sub = [e.start && e.ende ? `${e.start}–${e.ende}` : "", e.ort, e.rolle ? `Rolle: ${e.rolle}` : ""]
            .filter(Boolean).join(" · ");

          let actions = `
            <button class="btn small ghost" data-details="${e.training_id}">Details</button>
            <button class="btn small" data-checkin="today" data-eid="${e.einteilung_id}">Check-in</button>
            <button class="btn small danger" data-withdraw="${e.einteilung_id}">Austragen</button>
          `;

          const html = `
            <div class="item">
              <div class="itemMain">
                <div class="itemTitle">${e.datum || ""} <b>${e.gruppe || ""}</b></div>
                <div class="itemSub">${sub}</div>
                <div class="badges">${badges.join("")}</div>
              </div>
              <div class="itemActions">${actions}</div>
            </div>
          `;
          container.insertAdjacentHTML("beforeend", html);
        });

        container.querySelectorAll("[data-details]").forEach(btn => {
          btn.addEventListener("click", async () => {
            await openTrainingDetails(btn.getAttribute("data-details"));
          });
        });

        container.querySelectorAll("[data-withdraw]").forEach(btn => {
          btn.addEventListener("click", async () => {
            if (!confirm("Wirklich austragen?")) return;
            const id = btn.getAttribute("data-withdraw");
            const res = await api("apiWithdraw", token, id);
            if (!res.ok) alert(res.error || "Fehler");
            await refreshAll();
          });
        });

        container.querySelectorAll("[data-checkin]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const mode = btn.getAttribute("data-checkin"); // today|late
            const eid = btn.getAttribute("data-eid");
            const res = await api("apiCheckin", token, eid, mode);
            if (!res.ok) alert(res.error || "Fehler");
            await refreshAll();
          });
        });
      }

      function renderUnavailable(list) {
        const el = $("unavailList");
        if (!el) return;
        el.innerHTML = "";

        if (!list || !list.length) {
          el.innerHTML = `<div class="empty">Keine Abmeldungen gesetzt.</div>`;
          return;
        }

        list.forEach(x => {
          el.insertAdjacentHTML("beforeend", `
            <div class="item">
              <div class="itemMain">
                <div class="itemTitle">${x.label || ""}</div>
                <div class="badges"><span class="badge info">Nicht verfügbar</span></div>
              </div>
              <div class="itemActions">
                <button class="btn small" data-unavail-off="${x.training_id}">Wieder verfügbar</button>
              </div>
            </div>
          `);
        });

        el.querySelectorAll("[data-unavail-off]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const tid = btn.getAttribute("data-unavail-off");
            const res = await api("apiUnsetUnavailable", token, tid);
            if (!res.ok) return alert(res.error || "Fehler");
            await refreshAll();
          });
        });
      }

      function renderBilling(res) {
        const sum = $("billingSummary");
        const listEl = $("billingList");
        sum.style.display = "none";
        listEl.innerHTML = "";

        if (!res.ok) {
          alert(res.error || "Fehler");
          return;
        }

        sum.style.display = "block";
        const totalItemsAmount = Number(res.totalAmount || 0) + Number(res.pendingTotalAmount || 0);
        const totalItemsHours = Number(res.totalHours || 0) + Number(res.pendingTotalHours || 0);
        sum.innerHTML = `
          <b>Abgerechnet:</b> ${res.totalAmount?.toFixed ? res.totalAmount.toFixed(2) : res.totalAmount} € ·
          <b>Stunden:</b> ${res.totalHours?.toFixed ? res.totalHours.toFixed(2) : res.totalHours} ·
          <b>Ausstehend:</b> ${res.pendingTotalAmount?.toFixed ? res.pendingTotalAmount.toFixed(2) : res.pendingTotalAmount} € ·
          <b>Gesamt:</b> ${totalItemsAmount.toFixed(2)} € / ${totalItemsHours.toFixed(2)}h
        `;

        // ABGERECHNETE ITEMS
        if (res.items && res.items.length > 0) {
          listEl.insertAdjacentHTML("beforeend", `<div style="margin: 16px 0 10px; font-weight: 600; padding: 10px; background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; border-radius: 4px;">✓ Abgerechnet (${res.items.length})</div>`);

          res.items.forEach(it => {
            const badges = [];
            badges.push(`<span class="badge ok">${Number(it.amount).toFixed(2)} €</span>`);
            badges.push(`<span class="badge">${it.hours}h</span>`);

            let actions = `<button class="btn small ghost" data-details="${it.training_id}">Details</button>`;
            if (sessionUser && sessionUser.is_admin) {
              actions += `
                <button class="btn small" data-admin-status="stattgefunden" data-training="${it.training_id}">stattgefunden</button>
                <button class="btn small danger" data-admin-status="ausgefallen" data-training="${it.training_id}">ausgefallen</button>
              `;
            }

            listEl.insertAdjacentHTML("beforeend", `
              <div class="item" style="background: rgba(34, 197, 94, 0.05); border-left: 3px solid #22c55e;">
                <div class="itemMain">
                  <div class="itemTitle">${it.datum} <b>${it.gruppe || ""}</b></div>
                  <div class="itemSub">${[it.start && it.ende ? `${it.start}–${it.ende}` : "", it.ort].filter(Boolean).join(" · ")}</div>
                  <div class="badges">${badges.join("")}</div>
                </div>
                <div class="itemActions">${actions}</div>
              </div>
            `);
          });
        }

        // AUSSTEHENDE ITEMS
        if (res.pending && res.pending.length > 0) {
          listEl.insertAdjacentHTML("beforeend", `<div style="margin: 16px 0 10px; font-weight: 600; padding: 10px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; border-radius: 4px;">⏳ Offen / Ausstehend (${res.pending.length})</div>`);

          res.pending.forEach(it => {
            const badges = [];
            badges.push(`<span class="badge warn">${it.status}</span>`);
            badges.push(`<span class="badge">${Number(it.amount).toFixed(2)} €</span>`);
            badges.push(`<span class="badge">${it.hours}h</span>`);

            let actions = `<button class="btn small ghost" data-details="${it.training_id}">Details</button>`;

            listEl.insertAdjacentHTML("beforeend", `
              <div class="item" style="background: rgba(245, 158, 11, 0.05); border-left: 3px solid #f59e0b;">
                <div class="itemMain">
                  <div class="itemTitle">${it.datum} <b>${it.gruppe || ""}</b></div>
                  <div class="itemSub">${[it.start && it.ende ? `${it.start}–${it.ende}` : "", it.ort].filter(Boolean).join(" · ")}</div>
                  <div class="badges">${badges.join("")}</div>
                </div>
                <div class="itemActions">${actions}</div>
              </div>
            `);
          });
        }

        // Keine Items vorhanden
        if ((!res.items || !res.items.length) && (!res.pending || !res.pending.length)) {
          listEl.innerHTML = `<div class="empty">Keine Einträge im Zeitraum.</div>`;
          return;
        }

        listEl.querySelectorAll("[data-details]").forEach(btn => {
          btn.addEventListener("click", async () => {
            await openTrainingDetails(btn.getAttribute("data-details"));
          });
        });

        listEl.querySelectorAll("[data-admin-status]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const trainingId = btn.getAttribute("data-training");
            const status = btn.getAttribute("data-admin-status");
            let reason = "";
            if (status === "ausgefallen") {
              reason = prompt("Ausfallgrund (z.B. Ferien/Krank/…):", "Ferien") || "Admin";
            }
            const res2 = await api("apiAdminSetTrainingStatus", token, trainingId, status, reason);
            if (!res2.ok) alert(res2.error || "Fehler");
            await refreshAll();
          });
        });
      }

      async function tryBootstrap() {
        if (!token) return false;

        const res = await api("apiBootstrap", token);
        if (!res.ok) return false;

        sessionUser = res.user;
        allTrainings = res.upcoming || [];
        allMine = res.mineActive || [];
        allUnavailable = res.myUnavailable || [];

        $("loginCard").style.display = "none";
        $("mainCard").style.display = "block";
        $("userbox").style.display = "flex";
        $("userName").textContent = sessionUser.name + (sessionUser.is_admin ? " (Admin)" : "");

        const now = new Date();
        $("billYear").value = now.getFullYear();
        $("billHalf").value = (now.getMonth() <= 5) ? "H1" : "H2";

        initFilters();
        initMineFilters();
        renderTrainings(getFilteredTrainings(), $("trainingsList"), false);
        renderMine(getFilteredMineEntries());
        renderUnavailable(getFilteredUnavailable());

        if (sessionUser.is_admin) {
          $("adminTabBtn").style.display = "inline-flex";
          initAdminFilters();
          renderTrainings(getFilteredAdminTrainings(), $("adminTrainingsList"), true);
          await refreshAdminUsers(false);
        } else {
          $("adminTabBtn").style.display = "none";
        }
        return true;
      }

      async function refreshAll() {
        const ok = await tryBootstrap();
        if (!ok) {
          token = "";
          localStorage.removeItem(LS_TOKEN);
          sessionUser = null;
          $("loginCard").style.display = "block";
          $("mainCard").style.display = "none";
          $("userbox").style.display = "none";
          showLoginMsg("Bitte erneut anmelden.");
        }
      }

      // ===== Profile =====
      function openModal(id) { $(id).style.display = "flex"; }
      function closeModal(id) { $(id).style.display = "none"; }

      async function openProfile() {
        const res = await api("apiGetMyProfile", token);
        if (!res.ok) return alert(res.error || "Fehler");
        const t = res.trainer;

        $("profileName").textContent = t.name;
        $("profileId").textContent = t.trainer_id;
        $("profileRole").textContent = t.rolle_standard + (t.is_admin ? " (Admin)" : "");
        $("profileRate").textContent = (Number(t.stundensatz || 0)).toFixed(2) + " € / h";
        $("profileEmail").textContent = t.email || "—";
        $("profileSub").textContent = "Hier kannst du deine PIN ändern.";

        $("pinOld").value = "";
        $("pinNew").value = "";
        $("pinMsg").style.display = "none";
        $("pinMsg").textContent = "";

        openModal("profileModal");
      }

      async function savePin() {
        const oldPin = $("pinOld").value;
        const newPin = $("pinNew").value;

        const msg = $("pinMsg");
        msg.style.display = "none";

        const res = await api("apiChangeMyPin", token, oldPin, newPin);
        if (!res.ok) {
          msg.textContent = res.error || "Fehler";
          msg.style.display = "block";
          return;
        }
        msg.textContent = "PIN geändert.";
        msg.style.display = "block";
        $("pinOld").value = "";
        $("pinNew").value = "";
      }

      // ===== Training details =====
      async function openTrainingDetails(trainingId) {
        const res = await api("apiTrainingDetails", token, trainingId);
        if (!res.ok) return alert(res.error || "Fehler");

        const t = res.training;
        $("trainingSub").textContent = `${t.datum} · ${t.start}–${t.ende} · ${t.gruppe || ""} · ${t.ort || ""}`;

        const list = $("trainingSignupList");
        list.innerHTML = "";
        // --- NEU: Unavailable unterhalb anzeigen ---
        const ulist = $("trainingUnavailableList");
        ulist.innerHTML = "";

        if (!res.unavailable || !res.unavailable.length) {
          ulist.innerHTML = `<div class="empty">Keine Abmeldungen gesetzt.</div>`;
        } else {
          res.unavailable.forEach(u => {
            const badges = [];
            badges.push(`<span class="badge info">Nicht verfügbar</span>`);
            if (u.grund) badges.push(`<span class="badge warn">${u.grund}</span>`);
            if (u.created_at) badges.push(`<span class="badge">${u.created_at}</span>`);

            ulist.insertAdjacentHTML("beforeend", `
              <div class="item">
                <div class="itemMain">
                  <div class="itemTitle"><b>${u.name}</b></div>
                  <div class="badges">${badges.join("")}</div>
                </div>
              </div>
            `);
          });
        }

        if (!res.signups || !res.signups.length) {
          list.innerHTML = `<div class="empty">Noch niemand eingetragen.</div>`;
        } else {
          res.signups.forEach(s => {
            const badges = [];
            if (s.rolle) badges.push(`<span class="badge">${s.rolle}</span>`);
            if (s.checkin_am) badges.push(`<span class="badge ok">Check-in: ${s.checkin_am}</span>`);
            if (s.attendance) badges.push(`<span class="badge">${s.attendance}</span>`);

            list.insertAdjacentHTML("beforeend", `
              <div class="item">
                <div class="itemMain">
                  <div class="itemTitle"><b>${s.name}</b></div>
                  <div class="badges">${badges.join("")}</div>
                </div>
              </div>
            `);
          });
        }

        openModal("trainingModal");
      }

      // ===== Admin Users =====
      function renderAdminUsers(items) {
        const el = $("adminUsersList");
        el.innerHTML = "";
        if (!items || !items.length) {
          el.innerHTML = `<div class="empty">Keine Trainer.</div>`;
          return;
        }

        items.forEach(u => {
          const badges = [];
          badges.push(`<span class="badge">${u.aktiv}</span>`);
          if (u.is_admin === "TRUE") badges.push(`<span class="badge ok">Admin</span>`);
          const rate = Number(u.stundensatz_eur ?? u.stundensatz ?? 0);
          badges.push(`<span class="badge warn">${rate.toFixed(2)} €</span>`);

          el.insertAdjacentHTML("beforeend", `
            <div class="item">
              <div class="itemMain">
                <div class="itemTitle"><b>${u.name}</b> <span class="muted small">(${u.trainer_id})</span></div>
                <div class="itemSub">${u.email || ""}</div>
                <div class="badges">${badges.join("")}</div>
              </div>
              <div class="itemActions">
                <button class="btn small ghost" data-edit-user="${u.trainer_id}">Bearbeiten</button>
              </div>
            </div>
          `);
        });

        el.querySelectorAll("[data-edit-user]").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-edit-user");
            const u = items.find(x => String(x.trainer_id) === String(id));
            if (!u) return;
            $("u_trainer_id").value = u.trainer_id || "";
            $("u_name").value = u.name || "";
            $("u_email").value = u.email || "";
            $("u_pin").value = u.pin || "";
            $("u_rate").value = u.stundensatz_eur ?? u.stundensatz ?? "";
            $("u_aktiv").value = u.aktiv || "TRUE";
            $("u_admin").value = u.is_admin || "FALSE";
            setActiveSubtab("adminUsers");
          });
        });
      }

      async function refreshAdminUsers(showToast=true) {
        if (!sessionUser || !sessionUser.is_admin) return;
        const res = await api("apiAdminListTrainers", token);
        if (!res.ok) {
          if (showToast) alert(res.error || "Fehler");
          return;
        }
        renderAdminUsers(res.items || []);
      }

      // ===== Init / bindings =====
      async function init() {
        await loadTrainerSelect();

        // tabs
        document.querySelectorAll(".tab[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
});


        // admin subtabs
        document.querySelectorAll(".subTabs .tab").forEach(btn => {
          btn.addEventListener("click", () => setActiveSubtab(btn.dataset.subtab));
        });

        $("btnLogin").addEventListener("click", async () => {
          showLoginMsg("");
          const trainerId = $("trainerSelect").value;
          const pin = $("pinInput").value;
          if (!pin) return showLoginMsg("Bitte PIN eingeben.");

          const res = await api("apiLogin", trainerId, pin);
          if (!res.ok) return showLoginMsg(res.error || "Login fehlgeschlagen.");

          token = res.token;
          localStorage.setItem(LS_TOKEN, token);
          $("pinInput").value = "";
          await refreshAll();
        });

        $("btnLogout").addEventListener("click", async () => {
          await api("apiLogout", token);
          token = "";
          localStorage.removeItem(LS_TOKEN);
          sessionUser = null;
          $("loginCard").style.display = "block";
          $("mainCard").style.display = "none";
          $("userbox").style.display = "none";
          showLoginMsg("");
        });

        $("btnRefresh").addEventListener("click", refreshAll);
        $("btnRefreshMine").addEventListener("click", refreshAll);

        $("filterMonth").addEventListener("change", () => {
        renderTrainings(getFilteredTrainings(), $("trainingsList"), false);
        });
        $("filterGroup").addEventListener("change", () => {
        renderTrainings(getFilteredTrainings(), $("trainingsList"), false);
        });
        $("filterCritical").addEventListener("change", () => {
        renderTrainings(getFilteredTrainings(), $("trainingsList"), false);
        });
        $("filterMineMonth").addEventListener("change", () => {
        renderMine(getFilteredMineEntries());
        renderUnavailable(getFilteredUnavailable());
        });

        // admin filters (if present)
        const fAdminMonth = $("filterAdminMonth");
        if (fAdminMonth) fAdminMonth.addEventListener("change", () => renderTrainings(getFilteredAdminTrainings(), $("adminTrainingsList"), true));
        const fAdminGroup = $("filterAdminGroup");
        if (fAdminGroup) fAdminGroup.addEventListener("change", () => renderTrainings(getFilteredAdminTrainings(), $("adminTrainingsList"), true));
        const fAdminStatus = $("filterAdminStatus");
        if (fAdminStatus) fAdminStatus.addEventListener("change", () => renderTrainings(getFilteredAdminTrainings(), $("adminTrainingsList"), true));
        const btnAdminRefresh = $("btnAdminRefresh");
        if (btnAdminRefresh) btnAdminRefresh.addEventListener("click", () => renderTrainings(getFilteredAdminTrainings(), $("adminTrainingsList"), true));

        $("btnBilling").addEventListener("click", async () => {
          const year = Number($("billYear").value);
          const half = $("billHalf").value;
          const res = await api("apiBillingHalfyear", token, year, half);
          renderBilling(res);
        });

        $("btnAdminUsersRefresh").addEventListener("click", () => refreshAdminUsers(true));
        $("btnAdminUserSave").addEventListener("click", async () => {
          const payload = {
            trainer_id: $("u_trainer_id").value,
            name: $("u_name").value,
            email: $("u_email").value,
            pin: $("u_pin").value,
            stundensatz: $("u_rate").value,
            aktiv: $("u_aktiv").value,
            is_admin: $("u_admin").value,
          };
          const res = await api("apiAdminUpsertTrainer", token, payload);
          if (!res.ok) return alert(res.error || "Fehler");
          alert("Gespeichert.");
          await refreshAdminUsers(false);
        });

        // profile modal bindings
        $("userName").addEventListener("click", () => openProfile());
        $("profileClose").addEventListener("click", () => closeModal("profileModal"));
        $("btnPinSave").addEventListener("click", savePin);
        $("profileModal").addEventListener("click", (e) => { if (e.target.id === "profileModal") closeModal("profileModal"); });

        // training modal bindings
        $("trainingClose").addEventListener("click", () => closeModal("trainingModal"));
        $("trainingModal").addEventListener("click", (e) => { if (e.target.id === "trainingModal") closeModal("trainingModal"); });

        // initial state
        setActiveTab("trainings");
        setActiveSubtab("adminTrainings");

        if (token) {
          const ok = await tryBootstrap();
          if (!ok) {
            token = "";
            localStorage.removeItem(LS_TOKEN);
          }
        }
      }

      init();
      </script>
